@page "/nuevoeditarturno"
@inject IGenericService<Turno> TurnoService
@inject IGenericService<Paciente> PacienteService
@inject IGenericService<Profesional> ProfesionalService
@inject NavigationManager NavigationManager
@inject SweetAlertService SweetAlert

<HeaderPage TitlePage="@(IdTurnoEditado == 0 ? "Agregar Turno" : "Editar Turno")" />

@if (turno == null || pacientes == null || profesionales == null)
{
    <p class="text-center mt-3"><em>Cargando...</em></p>
}
else
{
    <div class="form-container">
        <EditForm Model="turno" OnValidSubmit="Guardar">
            <DataAnnotationsValidator />

            <!-- Profesional -->
            <div class="form-group mb-2">
                <label for="ProfesionalId" class="form-label">Profesional: <span class="text-danger">*</span></label>
                <InputSelect id="ProfesionalId" class="form-select" @bind-Value="turno.ProfesionalId">
                    <option value="">Seleccione un profesional</option>
                    @foreach (var profesional in profesionales)
                    {
                        <option value="@profesional.Id">@profesional.Nombre</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => turno.ProfesionalId)" />
            </div>

            <!-- Paciente -->
            <div class="form-group mb-2">
                <label for="PacienteId" class="form-label">Paciente: <span class="text-danger">*</span></label>
                <InputSelect id="PacienteId" class="form-select" @bind-Value="turno.PacienteId">
                    <option value="">Seleccione un paciente</option>
                    @foreach (var paciente in pacientes)
                    {
                        <option value="@paciente.Id">@paciente.Nombre</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => turno.PacienteId)" />
            </div>

            <!-- Fecha y Duración en la misma línea -->
            <div class="row-fields">
                <div class="form-group mb-2 col-field">
                    <label for="FechaHora" class="form-label">Fecha y Hora: <span class="text-danger">*</span></label>
                    <input type="datetime-local"
                           id="FechaHora"
                           class="form-control"
                           value="@ObtenerFechaHoraParaInput()"
                           @onchange="ActualizarFechaHora" />
                    <ValidationMessage For="@(() => turno.FechaHora)" />
                    @if (mostrarErrorFechaHora)
                    {
                        <div class="text-danger small">El campo Fecha y Hora es obligatorio.</div>
                    }
                </div>
                <div class="form-group mb-2 col-field">
                    <label for="DuracionMinutos" class="form-label">Duración (minutos): <span class="text-danger">*</span></label>
                    <InputNumber id="DuracionMinutos" class="form-control" @bind-Value="turno.DuracionMinutos" />
                    <ValidationMessage For="@(() => turno.DuracionMinutos)" />
                </div>
            </div>

            <!-- Estado como lista desplegable -->
            <div class="form-group mb-2">
                <label for="EstadoTurno" class="form-label">Estado: <span class="text-danger">*</span></label>
                <InputSelect id="EstadoTurno" class="form-select" @bind-Value="turno.EstadoTurno">
                    @foreach (var estado in Enum.GetValues<EstadoTurnoEnum>())
                    {
                        <option value="@estado">@estado.ToString()</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => turno.EstadoTurno)" />
            </div>

            <!-- Botones de acción -->
            <div class="form-actions">
                <button type="submit" class="btn btn-login mb-2" disabled="@guardando">
                    @if (guardando)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Guardando...</span>
                    }
                    else
                    {
                        <span>Guardar</span>
                    }
                </button>
                <button type="button" class="btn btn-register mb-2" @onclick="Cancelar" disabled="@guardando">Cancelar</button>
            </div>
        </EditForm>
    </div>
}

@code {
    //Define un parámetro que llega como variable que indica si se crea o se edita un paciente
    [SupplyParameterFromQuery]
    [Parameter]
    public int IdTurnoEditado { get; set; }

    private Turno? turno;
    private List<Paciente>? pacientes;
    private List<Profesional>? profesionales;
    private bool guardando = false;
    private bool mostrarErrorFechaHora = false;

    // Se ejecuta al inicializar el componente
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Cargar listas de pacientes y profesionales para la lista desplegable
            pacientes = await PacienteService.GetAllAsync(string.Empty);
            profesionales = await ProfesionalService.GetAllAsync(string.Empty);

            if (IdTurnoEditado != 0)
            {
                // Cargar el turno existente para editar
                turno = await TurnoService.GetByIdAsync(IdTurnoEditado);
                if (turno == null)
                {
                    await SweetAlert.FireAsync("Error", "No se encontró el turno", SweetAlertIcon.Error);
                    turno = new Turno();
                }
            }
            else
            {
                // Crear un turno nuevo con valores por defecto
                turno = new Turno
                {
                    EstadoTurno = EstadoTurnoEnum.Reservado,
                    DuracionMinutos = 60
                };
            }
        }
        catch (Exception ex)
        {
            await SweetAlert.FireAsync("Error", $"Error al cargar datos: {ex.Message}", SweetAlertIcon.Error);
            turno = new Turno();
            pacientes = new List<Paciente>();
            profesionales = new List<Profesional>();
        }
    }

    // Convierte la fecha del turno al formato que requiere el input datetime-local (por ej, 2025-05-15 10:00).
    private string ObtenerFechaHoraParaInput()
    {
        if (turno?.FechaHora != null &&
            turno.FechaHora != DateTime.MinValue &&
            turno.FechaHora.Year > 1900)
        {
            // Formato requerido: "yyyy-MM-ddTHH:mm"
            return turno.FechaHora.ToString("yyyy-MM-ddTHH:mm");
        }
        return string.Empty;
    }

    // Actualiza la fecha del turno cuando el usuario cambia el input
    private void ActualizarFechaHora(ChangeEventArgs e)
    {
        if (turno != null && e.Value != null)
        {
            var valorFechaHora = e.Value.ToString();
            if (!string.IsNullOrWhiteSpace(valorFechaHora) && DateTime.TryParse(valorFechaHora, out var fechaHora))
            {
                turno.FechaHora = fechaHora;
                mostrarErrorFechaHora = false;
            }
            else
            {
                turno.FechaHora = DateTime.MinValue;
            }
        }
    }

    // Guarda el turno (crear o actualizar)
    private async Task Guardar()
    {
        // Validación manual: verificar que la fecha sea válida
        mostrarErrorFechaHora = turno == null ||
                               turno.FechaHora == DateTime.MinValue ||
                               turno.FechaHora.Year < 1900;

        if (mostrarErrorFechaHora)
        {
            StateHasChanged();
            return;
        }

        try
        {
            guardando = true;
            StateHasChanged();

            if (turno != null)
            {
                // Limpiar relaciones para evitar referencia circular al serializar
                turno.Paciente = null;
                turno.Profesional = null;

                // Guardar según el modo (crear o editar)
                if (IdTurnoEditado == 0)
                {
                    await TurnoService.AddAsync(turno);
                    await SweetAlert.FireAsync("Éxito", "Turno agregado correctamente", SweetAlertIcon.Success);
                }
                else
                {
                    turno.Id = IdTurnoEditado;
                    await TurnoService.UpdateAsync(turno);
                    await SweetAlert.FireAsync("Éxito", "Turno actualizado correctamente", SweetAlertIcon.Success);
                }

                // Redirigir a la lista de turnos
                NavigationManager.NavigateTo("/turnos");
            }
        }
        catch (Exception ex)
        {
            await SweetAlert.FireAsync("Error", $"Error al guardar: {ex.Message}", SweetAlertIcon.Error);
        }
        finally
        {
            guardando = false;
        }
    }

    // Cancela la operación y vuelve a la lista de turnos
    private void Cancelar()
    {
        NavigationManager.NavigateTo("/turnos");
    }
}