@page "/nuevoeditarturno"
@inject IGenericService<Turno> TurnoService
@inject IGenericService<Paciente> PacienteService
@inject IGenericService<Profesional> ProfesionalService
@inject NavigationManager NavigationManager
@inject SweetAlertService SweetAlert

<HeaderPage TitlePage="@(IdTurnoEditado == 0 ? "Agregar Turno" : "Editar Turno")" />

@if (turno == null || pacientes == null || profesionales == null)
{
    <p class="text-center mt-3"><em>Cargando...</em></p>
}
else
{
    <div class="form-container">
        <EditForm Model="turno" OnValidSubmit="Guardar">
            <DataAnnotationsValidator />

            <!-- Fecha y Duración en la misma línea -->
            <div class="row-fields">
                <div class="form-group mb-2 col-field">
                    <label for="FechaHora" class="form-label">Fecha y Hora: <span class="text-danger">*</span></label>
                    <input type="datetime-local"
                           id="FechaHora"
                           class="form-control"
                           value="@ObtenerFechaHoraParaInput()"
                           @onchange="ActualizarFechaHora" />
                    <ValidationMessage For="@(() => turno.FechaHora)" />
                    @if (mostrarErrorFechaHora)
                    {
                        <div class="text-danger small">El campo Fecha y Hora es obligatorio.</div>
                    }
                </div>
                <div class="form-group mb-2 col-field">
                    <label for="DuracionMinutos" class="form-label">Duración (minutos): <span class="text-danger">*</span></label>
                    <InputNumber id="DuracionMinutos" class="form-control" @bind-Value="turno.DuracionMinutos" />
                    <ValidationMessage For="@(() => turno.DuracionMinutos)" />
                </div>
            </div>

            <!-- Selector de Estado personalizado (sin iconos, solo color #444444) -->
            <div class="form-group mb-2">
                <label class="form-label">Estado: <span class="text-danger">*</span></label>
                <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    @foreach (var estado in Enum.GetValues<EstadoTurnoEnum>())
                    {
                        <button type="button"
                                class="estado-pill"
                                @onclick="() => SeleccionarEstado(estado)"
                                aria-pressed="@(turno?.EstadoTurno == estado)"
                                style="margin-bottom: 0.5em; width: 80%; text-align: center; color: #444444;">
                            <span style="width: 100%; font-weight: 700; color: #444444;">@estado.ToString()</span>
                        </button>
                    }
                </div>
                <ValidationMessage For="@(() => turno.EstadoTurno)" />
            </div>

            <!-- Botones de acción -->
            <div class="form-actions">
                <button type="submit" class="btn btn-login mb-2" disabled="@guardando">
                    @if (guardando)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Guardando...</span>
                    }
                    else
                    {
                        <span>Guardar</span>
                    }
                </button>
                <button type="button" class="btn btn-register mb-2" @onclick="Cancelar" disabled="@guardando">Cancelar</button>
            </div>
        </EditForm>
    </div>
}

@code {
    // Parámetro que indica si estamos editando (tiene un ID) o creando (ID = 0)
    [SupplyParameterFromQuery]
    [Parameter]
    public int IdTurnoEditado { get; set; }

    // Variables del componente
    private Turno? turno;
    private List<Paciente>? pacientes;
    private List<Profesional>? profesionales;
    private bool guardando = false;
    private bool mostrarErrorFechaHora = false;

    // Se ejecuta al inicializar el componente
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Cargar listas de pacientes y profesionales para los dropdowns
            pacientes = await PacienteService.GetAllAsync(string.Empty);
            profesionales = await ProfesionalService.GetAllAsync(string.Empty);

            if (IdTurnoEditado != 0)
            {
                // Modo edición: cargar el turno existente
                turno = await TurnoService.GetByIdAsync(IdTurnoEditado);
                if (turno == null)
                {
                    await SweetAlert.FireAsync("Error", "No se encontró el turno", SweetAlertIcon.Error);
                    turno = new Turno();
                }
            }
            else
            {
                // Modo creación: crear un turno nuevo con valores por defecto
                turno = new Turno
                {
                    EstadoTurno = EstadoTurnoEnum.Reservado,
                    DuracionMinutos = 60
                };
            }
        }
        catch (Exception ex)
        {
            await SweetAlert.FireAsync("Error", $"Error al cargar datos: {ex.Message}", SweetAlertIcon.Error);
            turno = new Turno();
            pacientes = new List<Paciente>();
            profesionales = new List<Profesional>();
        }
    }

    // Convierte la fecha del turno al formato que requiere el input datetime-local
    private string ObtenerFechaHoraParaInput()
    {
        if (turno?.FechaHora != null &&
            turno.FechaHora != DateTime.MinValue &&
            turno.FechaHora.Year > 1900)
        {
            // Formato requerido: "yyyy-MM-ddTHH:mm"
            return turno.FechaHora.ToString("yyyy-MM-ddTHH:mm");
        }
        return string.Empty;
    }

    // Actualiza la fecha del turno cuando el usuario cambia el input
    private void ActualizarFechaHora(ChangeEventArgs e)
    {
        if (turno != null && e.Value != null)
        {
            var valorFechaHora = e.Value.ToString();
            if (!string.IsNullOrWhiteSpace(valorFechaHora) && DateTime.TryParse(valorFechaHora, out var fechaHora))
            {
                turno.FechaHora = fechaHora;
                mostrarErrorFechaHora = false;
            }
            else
            {
                turno.FechaHora = DateTime.MinValue;
            }
        }
    }

    // Guarda el turno (crear o actualizar)
    private async Task Guardar()
    {
        // Validación manual: verificar que la fecha sea válida
        mostrarErrorFechaHora = turno == null ||
                               turno.FechaHora == DateTime.MinValue ||
                               turno.FechaHora.Year < 1900;

        if (mostrarErrorFechaHora)
        {
            StateHasChanged();
            return;
        }

        try
        {
            guardando = true;
            StateHasChanged();

            if (turno != null)
            {
                // Limpiar campos opcionales
                turno.MotivoCancelacion = null;

                // Limpiar relaciones para evitar referencia circular al serializar
                turno.Paciente = null;
                turno.Profesional = null;

                // Gestionar el campo CanceladoPorProfesional
                if (IdTurnoEditado != 0)
                {
                    // Al editar: mantener el valor original de CanceladoPorProfesional
                    var turnoOriginal = await TurnoService.GetByIdAsync(IdTurnoEditado);
                    if (turnoOriginal != null)
                    {
                        turno.CanceladoPorProfesional = turnoOriginal.CanceladoPorProfesional;
                    }
                }
                else
                {
                    // Al crear: siempre es false
                    turno.CanceladoPorProfesional = false;
                }

                // Guardar según el modo (crear o editar)
                if (IdTurnoEditado == 0)
                {
                    await TurnoService.AddAsync(turno);
                    await SweetAlert.FireAsync("Éxito", "Turno agregado correctamente", SweetAlertIcon.Success);
                }
                else
                {
                    turno.Id = IdTurnoEditado;
                    await TurnoService.UpdateAsync(turno);
                    await SweetAlert.FireAsync("Éxito", "Turno actualizado correctamente", SweetAlertIcon.Success);
                }

                // Redirigir a la lista de turnos
                NavigationManager.NavigateTo("/turnos");
            }
        }
        catch (Exception ex)
        {
            await SweetAlert.FireAsync("Error", $"Error al guardar: {ex.Message}", SweetAlertIcon.Error);
        }
        finally
        {
            guardando = false;
        }
    }

    // Cancela la operación y vuelve a la lista de turnos
    private void Cancelar()
    {
        NavigationManager.NavigateTo("/turnos");
    }

    private void SeleccionarEstado(EstadoTurnoEnum estado)
    {
        if (turno != null)
            turno.EstadoTurno = estado;
    }

    private string GetEstadoCss(EstadoTurnoEnum estado) => estado switch
    {
        EstadoTurnoEnum.Atendido => "estado-atendido",
        EstadoTurnoEnum.Reservado => "estado-reservado",
        EstadoTurnoEnum.Cancelado => "estado-cancelado",
        EstadoTurnoEnum.Confirmado => "estado-confirmado",
        EstadoTurnoEnum.Ausente => "estado-ausente",
        _ => ""
    };
}